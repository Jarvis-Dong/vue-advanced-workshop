<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.js"></script>

<div id="app">
  <form @submit="validate">
    <input v-model="text" />
    <br />
    <input v-model="email" />

    <ul v-if="!$v.valid" style="color: red;">
      <li v-for="error in $v.errors">
        {{ error }}
      </li>
    </ul>

    <input type="submit" :disabled="!$v.valid" />
  </form>
</div>

<script>
  const validationPlugin = {
    // Implement this!
    install(Vue) {
      Vue.mixin({
        computed: {
          $v() {
            const rules = this.$options.validations
            let valid = true
            const errors = []
            Object.keys(rules||{}).forEach((key) => {
              // const validData = this.$options.data[key]
              const validData = this[key]
              const rule = rules[key]
              const result = rule.validate(validData)
              if (!result) {
                valid = false
                errors.push(rule.message(key, validData))
              }
            })
            return {
              valid,
              errors,
            }
          },
        },
        // beforeCreated() {
        //   const rules = this.$options.validations
        //   if(rules) {
        //     // 在computed中添加$v
        //     this.$options.computed = Object.assign({}, this.$options.computed, {
        //       $v () {
        //         let valid = true
        //         const errors = []
        //         Object.keys(rules).forEach(key => {
        //           // const validData = this.$options.data[key]
        //           const validData = this[key]
        //           const rule = rules[key]
        //           const result = rule.valudate(validData)
        //           if (!result) {
        //             valid = false
        //             errors.push(rule.message(key, validData))

        //           }
        //         })
        //         return {
        //           valid,
        //           errors
        //         }
        //       }
        //     })
        //   }
        // }
      })
    },
  }

  Vue.use(validationPlugin)

  new Vue({
    el: '#app',
    data: {
      text: 'foo',
      email: '',
    },
    validations: {
      text: {
        validate: (value) => value.length >= 5,
        message: (key, value) =>
          `${key} should have a min length of 5, but got ${value.length}`,
      },
      email: {
        validate: (value) => /^(\w)+(\.\w+)*@(\w)+((\.\w{2,3}){1,3})$/.test(value),
        message: (key, value) => `${key} must be a valid email, but got ${/email/.test(value)}`,
      },
    },
    methods: {
      validate(e) {
        if (!this.$v.valid) {
          e.preventDefault()
          alert('not valid!')
        }
      },
    },
  })
</script>
